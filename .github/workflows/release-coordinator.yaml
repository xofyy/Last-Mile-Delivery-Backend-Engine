name: Release Coordinator

on:
  workflow_run:
    workflows: ["Build and Deploy to GKE", "Production CI/CD Pipeline", "Infrastructure Policy Check"]
    types:
      - completed
    branches:
      - develop

concurrency:
  group: release-coordinator-${{ github.sha }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write # Required for label creation
  actions: read

jobs:
  check-and-pr:
    name: Check Status & Create PR
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify All Workflows Passed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          echo "Checking workflow statuses for commit: $COMMIT_SHA"

          # 0. Early Exit: Check if PR already exists
          # This handles the "Fan-In" problem (3 workflows triggering this 3 times).
          # If the first run created the PR, subsequent runs will see it and exit gracefully.
          PR_EXISTS=$(gh pr list --base main --head develop --json url --jq '.[0].url')
          if [[ -n "$PR_EXISTS" ]]; then
            echo "âœ… PR already exists: $PR_EXISTS"
            echo "The work is already done. Exiting gracefully."
            exit 0
          fi
          
          # List of workflows that MUST pass
          REQUIRED_WORKFLOWS=("Build and Deploy to GKE" "Production CI/CD Pipeline" "Infrastructure Policy Check")
          
          ALL_PASSED=true
          
          for workflow in "${REQUIRED_WORKFLOWS[@]}"; do
            # Fetch status and conclusion
            # Returns json like: [{"status":"completed","conclusion":"success"}]
            JSON=$(gh run list --commit "$COMMIT_SHA" --workflow "$workflow" --json status,conclusion --jq '.[0]')
            
            # If no run found (JSON is null/empty), assume Skipped due to path filters
            if [[ -z "$JSON" || "$JSON" == "null" ]]; then
              echo "  -> Check: '$workflow' -> No run found (Assumed Skipped) -> PASS"
              continue
            fi

            STATUS=$(echo "$JSON" | jq -r .status)
            CONCLUSION=$(echo "$JSON" | jq -r .conclusion)

            echo "  -> Check: '$workflow' -> Status: $STATUS, Conclusion: $CONCLUSION"

            # If still running, we must wait (fail this check)
            if [[ "$STATUS" != "completed" ]]; then
               echo "     -> Still running. Exiting to wait for completion."
               ALL_PASSED=false
               break
            fi

            # If completed, check conclusion
            if [[ "$CONCLUSION" == "success" || "$CONCLUSION" == "skipped" ]]; then
               echo "     -> Success/Skipped. PASS."
            else
               echo "     -> FAILED. (Conclusion: $CONCLUSION)"
               ALL_PASSED=false
               break
            fi
          done

          if [[ "$ALL_PASSED" == "false" ]]; then
            echo "Not all workflows passed/completed yet. Exiting."
            exit 0 # Exit 0 to stay green, but do nothing
          else
            echo "All required workflows passed! Proceeding to PR."
          fi

      - name: Create Release PR
        run: |
          # 1. Ensure Label Exists
          gh label create "automated-pr" --color "0E8A16" --description "Created by Release Coordinator" --force || true

          # 2. Create PR
          gh pr create \
            --base main \
            --head develop \
            --title "Release: Promote Develop to Main" \
            --body "Automated PR created because ALL tests (Backend, AI, Infra) passed on develop." \
            --label "automated-pr" || echo "PR likely already exists"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
